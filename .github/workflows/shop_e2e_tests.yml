name: Run shop E2E tests
on:
  workflow_call:
    inputs:
      budoman-frontend_branch:
        required: false
        type: string
        default: develop
      budoman-backend_branch:
        required: false
        type: string
        default: develop
    secrets:
      BUDOMAN_FRONTEND_AWS_ACCESS_KEY_ID:
        required: true
      BUDOMAN_FRONTEND_AWS_SECRET_ACCESS_KEY:
        required: true
      BUDOMAN_BACKEND_AWS_ACCESS_KEY_ID:
        required: true
      BUDOMAN_BACKEND_AWS_SECRET_ACCESS_KEY:
        required: true
      BUDOMAN_BACKEND_SIDEKIQ_PANEL_LOGIN:
        required: true
      BUDOMAN_BACKEND_SIDEKIQ_PANEL_PASSWORD:
        required: true
jobs:
  run-e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Upload frontend repository
        uses: actions/checkout@v3
        with:
          repository: michal-siwiec/frontend
          path: frontend
          ref: ${{ inputs.budoman-frontend_branch }}
      - name: Create .env file for frontend application
        working-directory: frontend
        run: |
          cat <<EOF > .env
          API_URL=http://localhost:3333
          AWS_ACCESS_KEY_ID=${{ secrets.BUDOMAN_FRONTEND_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.BUDOMAN_FRONTEND_AWS_SECRET_ACCESS_KEY }}
          AWS_BUCKET=budoman-development
          EOF
      - name: Upload backend repository
        uses: actions/checkout@v3
        with:
          repository: michal-siwiec/backend
          path: backend
          ref: ${{ inputs.budoman-backend_branch }}
      - name: Create .env file for backend application
        working-directory: backend
        run: |
          cat <<EOF > .env
          AWS_ACCESS_KEY_ID=${{ secrets.BUDOMAN_BACKEND_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.BUDOMAN_BACKEND_AWS_SECRET_ACCESS_KEY }}
          SIDEKIQ_PANEL_LOGIN=${{ secrets.BUDOMAN_BACKEND_SIDEKIQ_PANEL_LOGIN }}
          SIDEKIQ_PANEL_PASSWORD=${{ secrets.BUDOMAN_BACKEND_SIDEKIQ_PANEL_PASSWORD }}
          RAILS_ENV=test
          EOF
      - name: Upload system tests repository
        uses: actions/checkout@v3
        with:
          repository: michal-siwiec/system-tests
          path: system-tests
      - name: Install dependencies for system test repository
        run: cd system-tests && npm install
      - name: Run Cypress tests
        id: cypress-tests
        uses: cypress-io/github-action@v6
        env:
          SIDEKIQ_PANEL_LOGIN: ${{ secrets.BUDOMAN_BACKEND_SIDEKIQ_PANEL_LOGIN }}
          SIDEKIQ_PANEL_PASSWORD: ${{ secrets.BUDOMAN_BACKEND_SIDEKIQ_PANEL_PASSWORD }}
          CI: true
        with:
          start: |
            docker compose -f ../frontend/docker-compose.yml up -d
            docker compose -f ../backend/docker-compose.yml up -d
          wait-on: 'http://localhost:3003/, http://localhost:3333/'
          wait-on-timeout: 120
          command: npm run tests:shop:e2e
          working-directory: system-tests
      - name: Upload Cypress screenshots
        if: failure() && steps.cypress-tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: system-tests/tests/e2e/shop/screenshots
